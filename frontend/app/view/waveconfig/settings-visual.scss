// Copyright 2025, Command Line Inc.
// SPDX-License-Identifier: Apache-2.0

// ============================================
// Settings Visual Component Styles
// VS Code-like settings panel experience
// ============================================

// Modified indicator color (matches VS Code)
$setting-modified-color: #e2c08d;

// Sidebar width
$sidebar-width: 200px;

// ============================================
// Main Layout Container
// ============================================

.settings-visual {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
    background: var(--main-bg-color);
    overflow: hidden;

    // ========================================
    // Header with Search Bar
    // ========================================

    .settings-visual-header {
        flex-shrink: 0;
        padding: 12px 16px;
        background: var(--main-bg-color);
        border-bottom: 1px solid var(--border-color);
    }

    // ========================================
    // Body containing Sidebar and List
    // ========================================

    .settings-visual-body {
        flex: 1;
        display: flex;
        min-height: 0; // Important for nested flexbox scrolling
        overflow: hidden;
    }

    // ========================================
    // Category Sidebar - Tree Structure
    // ========================================

    .settings-category-sidebar {
        width: $sidebar-width;
        min-width: $sidebar-width;
        border-right: 1px solid var(--border-color);
        overflow-y: auto;
        background: var(--main-bg-color);
        flex-shrink: 0;
        padding: 4px 0;

        .category-list {
            padding: 8px 0;
        }
    }

    .settings-category-tree-item {
        // Container for category + its subcategories
    }

    .settings-category-item {
        display: flex;
        align-items: center;
        padding: 6px 12px;
        cursor: pointer;
        gap: 6px;
        color: var(--secondary-text-color);
        transition: background-color 0.15s ease, color 0.15s ease;
        user-select: none;

        &:hover {
            background: var(--hover-bg-color);
            color: var(--main-text-color);
        }

        &.active {
            background: var(--highlight-bg-color);
            color: var(--main-text-color);
        }

        .tree-chevron {
            width: 12px;
            font-size: 9px;
            color: var(--grey-text-color);
            flex-shrink: 0;
            transition: transform 0.15s ease;
        }

        .tree-chevron-spacer {
            width: 12px;
            flex-shrink: 0;
        }

        .category-icon {
            width: 16px;
            text-align: center;
            font-size: 12px;
            opacity: 0.8;
            flex-shrink: 0;
        }

        .category-name {
            flex: 1;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .category-count {
            font-size: 10px;
            color: var(--grey-text-color);
            background: var(--panel-bg-color);
            padding: 1px 5px;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .modified-badge {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: $setting-modified-color;
            flex-shrink: 0;
        }
    }

    // Subcategory list (nested under expanded category)
    .settings-subcategory-list {
        padding-left: 30px;
        padding-bottom: 4px;
    }

    .settings-subcategory-item {
        display: flex;
        align-items: center;
        padding: 5px 12px;
        cursor: pointer;
        color: var(--secondary-text-color);
        font-size: 12px;
        transition: background-color 0.15s ease, color 0.15s ease;
        user-select: none;
        border-radius: 4px;
        margin: 1px 8px 1px 0;

        &:hover {
            background: var(--hover-bg-color);
            color: var(--main-text-color);
        }

        &.active {
            color: var(--accent-color);
            background: rgb(from var(--accent-color) r g b / 0.1);
        }

        .subcategory-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    }

    // ========================================
    // Main Content Area (legacy, kept for compatibility)
    // ========================================

    .settings-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        overflow: hidden;
    }

    // ========================================
    // Search Bar
    // ========================================

    .settings-search {
        display: flex;
        align-items: center;
        background: var(--form-element-bg-color);
        border: 1px solid var(--form-element-border-color);
        border-radius: 6px;
        padding: 0 12px;
        transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;

        &:hover {
            border-color: var(--form-element-primary-color, var(--accent-color));
        }

        &:focus-within {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgb(from var(--accent-color) r g b / 0.2);
            background: linear-gradient(rgb(0 0 0 / 0.15), rgb(0 0 0 / 0.15)), var(--form-element-bg-color);
        }

        .search-icon {
            color: var(--grey-text-color);
            margin-right: 8px;
            font-size: 13px;
        }

        input {
            flex: 1;
            padding: 8px 0;
            background: transparent;
            border: none;
            color: var(--main-text-color);
            font-size: 14px;
            outline: none;

            &::placeholder {
                color: var(--grey-text-color);
            }
        }

        .clear-button {
            padding: 4px 6px;
            background: transparent;
            border: none;
            color: var(--grey-text-color);
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.15s ease, color 0.15s ease;

            &:hover {
                background: var(--hover-bg-color);
                color: var(--main-text-color);
            }
        }
    }

    // Legacy search bar (kept for compatibility)
    .search-bar {
        position: sticky;
        top: 0;
        z-index: 10;
        padding: 12px 16px;
        background: var(--main-bg-color);
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
    }

    .settings-search-input {
        display: flex;
        align-items: center;
        background: var(--form-element-bg-color);
        border: 1px solid var(--form-element-border-color);
        border-radius: 6px;
        padding: 0 12px;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;

        &:focus-within {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgb(from var(--accent-color) r g b / 0.2);
        }

        .search-icon {
            color: var(--grey-text-color);
            margin-right: 8px;
            font-size: 13px;
        }

        .search-input {
            flex: 1;
            padding: 8px 0;
            background: transparent;
            border: none;
            color: var(--main-text-color);
            font-size: 14px;
            outline: none;

            &::placeholder {
                color: var(--grey-text-color);
            }
        }

        .result-count {
            font-size: 12px;
            color: var(--grey-text-color);
            margin-right: 8px;
            white-space: nowrap;
        }

        .clear-btn {
            padding: 4px 6px;
            background: transparent;
            border: none;
            color: var(--grey-text-color);
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.15s ease, color 0.15s ease;

            &:hover {
                background: var(--hover-bg-color);
                color: var(--main-text-color);
            }
        }
    }

    // ========================================
    // Settings List
    // ========================================

    .settings-list {
        flex: 1;
        overflow-y: auto;
        min-height: 0; // Important for nested flexbox scrolling
        // No top padding - headers need to stick flush to the top
        // Bottom padding is calculated dynamically in JS to allow last section header to stick

        .settings-category-section {
            // Opaque background for entire section (VS Code style)
            background: var(--panel-bg-color);
            margin: 8px 12px 16px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgb(0 0 0 / 0.06), 0 1px 2px rgb(0 0 0 / 0.03);
            // Note: overflow:hidden would break sticky, so we use border-radius on children instead

            &:first-child {
                margin-top: 8px;
            }

            .settings-category-header {
                position: sticky;
                // Stick exactly to the top with no gap
                top: 0;
                z-index: 5;
                padding: 10px 16px;
                // Opaque background: theme color layered over solid base to eliminate any transparency
                background-color: var(--main-bg-color);
                background: linear-gradient(var(--highlight-bg-color), var(--highlight-bg-color)), var(--main-bg-color);
                font-weight: 600;
                font-size: 14px;
                color: var(--main-text-color);
                // No border-bottom when not stuck - subsection header provides separation
                display: flex;
                align-items: center;
                gap: 8px;
                // Round top corners to match section (when not stuck)
                border-radius: 8px 8px 0 0;
                transition: border-radius 0.1s ease, box-shadow 0.15s ease;

                i,
                .category-icon {
                    font-size: 14px;
                    width: 18px;
                    text-align: center;
                    color: var(--secondary-text-color);
                }
            }

            // When header is stuck: square corners, full width appearance
            .settings-category-header.is-stuck {
                border-radius: 0;
                // No border/shadow by default - subcategory header provides separation
                box-shadow: none;
                // Extend visually to edges when stuck
                margin-left: -1px;
                margin-right: -1px;
                padding-left: 17px;
                padding-right: 17px;
            }

            // Category header gets border and shadow only when no subcategory header is stuck below it
            &:not(:has(.settings-subcategory-header.is-stuck)) .settings-category-header.is-stuck {
                border-bottom: 1px solid var(--border-color);
                box-shadow: 0 2px 8px rgb(0 0 0 / 0.12), 0 1px 3px rgb(0 0 0 / 0.08);
            }

            // Subcategory section wrapper - no gaps
            .settings-subcategory-section {
                margin: 0;
                padding: 0;

                &:first-child {
                    // First subcategory sits directly under category header
                    margin-top: 0;
                }
            }

            // Sticky subcategory header - sticks below category header
            .settings-subcategory-header {
                position: sticky;
                // Position below the category header (header height ~38px)
                // Use 37px to create 1px overlap, eliminating any sub-pixel gap
                top: 37px;
                z-index: 4;
                padding: 6px 16px;
                font-weight: 500;
                font-size: 11px;
                color: var(--grey-text-color);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                // Use theme variable for light mode compatibility
                background: var(--panel-bg-color);
                border-bottom: 1px solid var(--border-color);
                margin: 0;
                transition: box-shadow 0.15s ease;
            }

            // When subcategory header is stuck (detected by JS)
            .settings-subcategory-header.is-stuck {
                box-shadow: 0 2px 4px rgb(0 0 0 / 0.08);
            }

            .settings-subcategory-content {
                // Settings rows within a subcategory
            }

            // Setting rows within sections
            .setting-row {
                background: var(--panel-bg-color);
                border-bottom: 1px solid var(--border-color);
                transition: background-color 0.15s ease;

                &:hover {
                    background: var(--hover-bg-color);
                }

                &:last-child {
                    border-bottom: none;
                    border-radius: 0 0 8px 8px;
                }
            }
        }

        // Search results header
        .settings-search-results-header {
            padding: 10px 16px;
            background: var(--highlight-bg-color);
            font-size: 13px;
            color: var(--secondary-text-color);
            border-bottom: 1px solid var(--border-color);
        }
    }

    // Empty state (displayed when no search results)
    .settings-empty {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 24px;
        color: var(--grey-text-color);
        text-align: center;

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 14px;
            color: var(--secondary-text-color);
        }

        .empty-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--secondary-text-color);
            margin-bottom: 8px;
        }

        .empty-description {
            font-size: 13px;
        }
    }

    // ========================================
    // Loading State
    // ========================================

    .settings-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--secondary-text-color);

        .loading-spinner {
            margin-right: 8px;
            animation: spin 1s linear infinite;
        }
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }

    // ========================================
    // Error State
    // ========================================

    .settings-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 24px;
        background: rgb(from var(--error-color) r g b / 0.1);
        border: 1px solid var(--error-color);
        border-radius: 8px;
        margin: 16px;
        color: var(--error-color);

        i {
            font-size: 24px;
            margin-bottom: 12px;
        }

        .error-message {
            text-align: center;
        }

        .error-retry {
            margin-top: 16px;
            padding: 8px 16px;
            background: var(--error-color);
            color: var(--main-text-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.15s ease;

            &:hover {
                opacity: 0.9;
            }
        }
    }
}

// ============================================
// Setting Row Overrides for Visual Panel
// (Extends base .setting-row from settings-controls.scss)
// ============================================

.settings-visual .setting-row {
    .setting-key {
        font-size: 11px;
        font-family: var(--fixed-font);
        color: var(--grey-text-color);
        opacity: 0;
        transition: opacity 0.15s ease;
        margin-left: 8px;
    }

    &:hover .setting-key {
        opacity: 1;
    }

    .setting-header {
        flex-wrap: wrap;
    }

    .setting-control-container {
        margin-left: auto;
    }
}

// ============================================
// Filter Toolbar (Modified Only, etc.)
// ============================================

.settings-filter-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--main-bg-color);
    border-bottom: 1px solid var(--border-color);

    .filter-chip {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: var(--panel-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        font-size: 12px;
        color: var(--secondary-text-color);
        cursor: pointer;
        transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
        user-select: none;

        &:hover {
            background: var(--hover-bg-color);
            color: var(--main-text-color);
        }

        &.active {
            background: rgb(from var(--accent-color) r g b / 0.15);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        i {
            font-size: 10px;
        }
    }

    .filter-separator {
        width: 1px;
        height: 20px;
        background: var(--border-color);
    }

    .filter-count {
        font-size: 12px;
        color: var(--grey-text-color);
        margin-left: auto;
    }
}

// ============================================
// Actions Bar (Save, Reset All)
// ============================================

.settings-actions-bar {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
    padding: 12px 16px;
    background: var(--main-bg-color);
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;

    .unsaved-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: $setting-modified-color;
        margin-right: auto;

        .unsaved-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: $setting-modified-color;
        }
    }

    .action-btn {
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 13px;
        cursor: pointer;
        transition: background-color 0.15s ease, opacity 0.15s ease;

        &.primary {
            background: var(--accent-color);
            color: var(--button-text-color);
            border: 1px solid var(--accent-color);

            &:hover:not(:disabled) {
                opacity: 0.9;
            }
        }

        &.secondary {
            background: transparent;
            color: var(--secondary-text-color);
            border: 1px solid var(--border-color);

            &:hover:not(:disabled) {
                background: var(--hover-bg-color);
                color: var(--main-text-color);
            }
        }

        &:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    }
}

// ============================================
// Tooltip Styles for Settings
// ============================================

.settings-tooltip {
    position: absolute;
    z-index: 100;
    padding: 8px 12px;
    background: var(--modal-bg-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgb(0 0 0 / 0.3);
    font-size: 12px;
    color: var(--secondary-text-color);
    max-width: 300px;
    pointer-events: none;

    .tooltip-key {
        font-family: var(--fixed-font);
        color: var(--grey-text-color);
        margin-bottom: 4px;
    }

    .tooltip-default {
        margin-top: 4px;
        padding-top: 4px;
        border-top: 1px solid var(--border-color);

        span {
            font-family: var(--fixed-font);
            color: var(--accent-color);
        }
    }
}

// ============================================
// Responsive Styles
// ============================================

@media (max-width: 768px) {
    .settings-visual {
        .settings-sidebar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 20;
            transform: translateX(-100%);
            transition: transform 0.2s ease;
            box-shadow: none;

            &.open {
                transform: translateX(0);
                box-shadow: 2px 0 8px rgb(0 0 0 / 0.3);
            }
        }

        .settings-main {
            width: 100%;
        }

        // Mobile menu toggle
        .mobile-menu-toggle {
            display: flex;
        }
    }
}

@media (min-width: 769px) {
    .settings-visual {
        .mobile-menu-toggle {
            display: none;
        }
    }
}

// ============================================
// Animations
// ============================================

// Fade in for settings appearing after search
.setting-row {
    animation: fadeIn 0.15s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-4px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

// Highlight animation when jumping to a setting
.setting-row.highlight {
    animation: highlight 1.5s ease;
}

@keyframes highlight {
    0%,
    20% {
        background: rgb(from var(--accent-color) r g b / 0.3);
    }
    100% {
        background: transparent;
    }
}

// ============================================
// Setting Links (related setting navigation)
// ============================================

.setting-link {
    color: var(--accent-color);
    cursor: pointer;
    text-decoration: none;
    transition: opacity 0.15s ease;

    &:hover {
        opacity: 0.8;
        text-decoration: underline;
    }
}

// Modified indicator pulse
.setting-row.modified .setting-label-container::after {
    content: "";
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: $setting-modified-color;
    margin-left: 8px;
    vertical-align: middle;
}

// ============================================
// Dark/Light Mode Adjustments
// (using css variables, adapts automatically)
// ============================================

// Ensure proper contrast in scrollbar
.settings-visual {
    .settings-list,
    .settings-sidebar {
        &::-webkit-scrollbar {
            width: 6px;
        }

        &::-webkit-scrollbar-track {
            background: transparent;
        }

        &::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb-color);
            border-radius: 3px;

            &:hover {
                background: var(--scrollbar-thumb-hover-color);
            }
        }
    }
}

// ============================================
// Focus Styles for Accessibility
// ============================================

.settings-visual {
    .category-item:focus-visible,
    .filter-chip:focus-visible,
    .action-btn:focus-visible {
        outline: 2px solid var(--accent-color);
        outline-offset: 2px;
    }

    .setting-row:focus-within {
        background: var(--hover-bg-color);
    }
}

// ============================================
// Keyboard Navigation Indicator
// ============================================

.settings-visual.keyboard-nav {
    .category-item:focus {
        background: var(--highlight-bg-color);
        color: var(--main-text-color);
    }

    .setting-row:focus-within {
        border-left-color: var(--accent-color);
    }
}
